@model Reservation.Models.ViewModels.ReservationViewModel
@{
    ViewData["Title"] = "訂位";
}

<!-- 頂部 Header -->
<header class="reservation-header">
    <div class="container-fluid">
        <div class="row align-items-center">
            <div class="col-auto">
                <a href="@Url.Action("Index", "Restaurant")" class="back-button">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="white" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/>
                    </svg>
                </a>
            </div>
            <div class="col text-center">
                <h1 class="reservation-header-title">@Model.Branch.Name</h1>
            </div>
            <div class="col-auto" style="width: 24px;"></div>
        </div>
    </div>
</header>

<!-- 餐廳資訊卡片 -->
<div class="container-fluid px-3 py-3">
    <div class="restaurant-info-card">
        <div class="row g-0">
            <div class="col-4">
                <div class="restaurant-image-wrapper-reservation">
                    <img src="@Url.Content(Model.Restaurant.ImageUrl)" alt="@Model.Restaurant.Name" class="restaurant-image-reservation" />
                </div>
            </div>
            <div class="col-8">
                <div class="restaurant-details-reservation">
                    <h2 class="restaurant-name-reservation">@Model.Restaurant.Name</h2>
                    <div class="restaurant-detail-item">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="#258cfb" viewBox="0 0 16 16">
                            <path d="M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10zm0-7a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/>
                        </svg>
                        <span>@Model.Restaurant.Location</span>
                    </div>
                    <div class="restaurant-detail-item">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="#258cfb" viewBox="0 0 16 16">
                            <path d="M3.654 1.328a.678.678 0 0 0-1.015-.063L1.605 2.3c-.483.484-.661 1.169-.45 1.77a17.568 17.568 0 0 0 4.168 6.608 17.569 17.569 0 0 0 6.608 4.168c.601.211 1.286.033 1.77-.45l1.034-1.034a.678.678 0 0 0-.063-1.015l-2.307-1.794a.678.678 0 0 0-.58-.122L9.78 10.22a.678.678 0 0 1-.58-.122L6.5 7.5a.678.678 0 0 1-.122-.58l.122-1.034a.678.678 0 0 0-.122-.58L3.654 1.328z"/>
                        </svg>
                        <span>@Model.Restaurant.Phone</span>
                    </div>
                    <div class="restaurant-detail-item">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="#258cfb" viewBox="0 0 16 16">
                            <path d="M8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71V3.5z"/>
                            <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm7-8A7 7 0 1 1 1 8a7 7 0 0 1 14 0z"/>
                        </svg>
                        <span>@Model.Restaurant.OpeningHours</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 訂位資料區塊 -->
    <div class="reservation-form-section">
        <h3 class="section-title">訂位資料</h3>
        
        <form method="post" action="@Url.Action("Index", "Reservation")" id="reservationForm">
            <input type="hidden" name="Restaurant.Id" value="@Model.Restaurant.Id" />
            <input type="hidden" name="Branch.Id" value="@Model.Branch.Id" />
            
            <!-- 訂位日期 -->
            <div class="form-group mb-3">
                <label class="form-label">訂位日期</label>
                <input type="date" 
                       class="form-control reservation-date-input" 
                       name="SelectedDate" 
                       id="reservationDate"
                       value="@(Model.SelectedDate?.ToString("yyyy-MM-dd") ?? DateTime.Today.ToString("yyyy-MM-dd"))"
                       min="@DateTime.Today.ToString("yyyy-MM-dd")"
                       max="@DateTime.Today.AddDays(90).ToString("yyyy-MM-dd")"
                       required />
            </div>

            <!-- 人數選擇 -->
            <div class="row mb-3">
                <div class="col-6">
                    <label class="form-label">大人</label>
                    <select class="form-select" name="AdultCount" id="adultCount" required>
                        @for (int i = 1; i <= 8; i++)
                        {
                            <option value="@i" selected="@(Model.AdultCount == i)">@i 位</option>
                        }
                    </select>
                </div>
                <div class="col-6">
                    <label class="form-label">小孩</label>
                    <select class="form-select" name="ChildCount" id="childCount">
                        @for (int i = 0; i <= 8; i++)
                        {
                            <option value="@i" selected="@(Model.ChildCount == i)">@i 位</option>
                        }
                    </select>
                </div>
            </div>
            <p class="reservation-info-text">線上訂位最多可至8位,如需團體訂位請撥打餐廳電話。</p>

            <!-- 時段選擇 -->
            <div class="time-slot-section">
                <div class="meal-period-tabs">
                    <button type="button" class="meal-period-tab active" data-period="中午">中午</button>
                    <button type="button" class="meal-period-tab" data-period="晚上">晚上</button>
                </div>
                <input type="hidden" name="SelectedMealPeriod" id="selectedMealPeriod" value="@Model.SelectedMealPeriod" />
                
                <div class="time-slots-grid" id="timeSlotsGrid">
                    @foreach (var slot in Model.AvailableTimeSlots)
                    {
                        <button type="button" 
                                class="time-slot-btn @(Model.SelectedTimeSlot == slot ? "active" : "")" 
                                data-slot="@slot">
                            @slot
                        </button>
                    }
                </div>
                <input type="hidden" name="SelectedTimeSlot" id="selectedTimeSlot" value="@Model.SelectedTimeSlot" />
            </div>

            <!-- 下一步按鈕 -->
            <div class="text-center mt-4">
                <button type="submit" class="btn btn-next-step">下一步</button>
            </div>
        </form>
    </div>

    <!-- 菜單展示區域 -->
    <div class="menu-section">
        <h3 class="section-title">菜單</h3>
        <div class="menu-carousel-wrapper">
            <div class="menu-carousel-container" id="menuCarouselContainer">
                <div class="menu-carousel-track" id="menuCarouselTrack">
                    @foreach(var menu in Model.Menus){
                        <div class="menu-item">
                            <!-- 添加 data-menu-id 屬性，用於點擊時識別是哪張圖片 -->
                            <img src="@Url.Content(menu.ImageUrl)" alt="菜單" class="menu-image" data-menu-id="@menu.Id" />
                        </div>
                    }
                </div>
            </div>
            <div class="menu-carousel-indicators" id="menuCarouselIndicators"></div>
        </div>
    </div>

    <!-- 菜單圖片全螢幕放大 Modal -->
    <div id="menuImageModal" class="menu-image-modal">
        <!-- 關閉按鈕 -->
        <button class="menu-modal-close" id="menuModalClose">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="white" viewBox="0 0 16 16">
                <path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/>
            </svg>
        </button>
        <div class="menu-modal-image-container" id="menuModalImageContainer">
        </div>
    </div>

    <!-- 訂位成功彈窗 -->
    <div class="modal fade" id="reservationSuccessModal" tabindex="-1" aria-labelledby="reservationSuccessModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content reservation-success-modal">
                <button type="button" class="btn-close btn-close-white reservation-close-btn" data-bs-dismiss="modal" aria-label="Close"></button>
                
                <div class="reservation-success-content">
                    <div class="success-icon-wrapper">
                        <div class="success-checkmark">
                            <svg viewBox="0 0 52 52" class="checkmark-svg">
                                <circle class="checkmark-circle" cx="26" cy="26" r="25" fill="none" stroke="white" stroke-width="2"/>
                                <path class="checkmark-check" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
                            </svg>
                        </div>
                    </div>
                    
                    <h2 class="reservation-success-title">訂位完成</h2>
                    
                    <p class="reservation-success-message">
                        可於遠百APP,【個人訊息功能】查詢訂候位記錄
                    </p>
                    
                    <button type="button" class="btn reservation-query-btn" onclick="window.location.href='@Url.Action("QueryRecord", "Restaurant")'">
                        訂位紀錄查詢
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {

            // 菜單輪播功能物件
            var menuCarousel = {
                track: $('#menuCarouselTrack'),
                container: $('#menuCarouselContainer'),
                items: $('.menu-item'),
                indicators: $('#menuCarouselIndicators'),
                currentIndex: 0,
                itemsPerPage: 3,
                totalGroups: 0,
                isDragging: false,
                startX: 0,
                startY: 0,
                currentX: 0,
                offsetX: 0,
                threshold: 50,
                
                // 初始化輪播
                init: function() {
                    var totalItems = this.items.length;
                    if (totalItems === 0) return;
                    
                    // 根據螢幕寬度更新每組顯示數量
                    this.updateItemsPerGroup();
                    
                    // 計算總組數
                    this.totalGroups = Math.ceil(totalItems / this.itemsPerPage);
                    
                    // 生成指示器
                    this.createIndicators();
                    
                    // 設定初始位置
                    this.updatePosition();
                    
                    // 綁定事件監聽器
                    this.bindEvents();
                },
                
                // 根據螢幕寬度更新每組顯示數量
                updateItemsPerGroup: function() {
                    var width = $(window).width();
                    if(width <= 768){
                        this.itemsPerPage = 2;
                    }else{
                        this.itemsPerPage = 3;
                    }
                    
                    var totalItems = this.items.length;
                    this.totalGroups = Math.ceil(totalItems / this.itemsPerPage);
                    
                    // 確保當前組索引不超過總組數
                    if (this.currentIndex >= this.totalGroups) {
                        this.currentIndex = this.totalGroups - 1;
                    }
                    
                    // 重新生成指示器（因為組數可能改變）
                    this.createIndicators();
                },
                
                // 生成指示器點點
                createIndicators: function() {
                    this.indicators.empty();
                    
                    // 如果只有一組，隱藏指示器
                    if (this.totalGroups <= 1) {
                        this.indicators.addClass('hidden');
                        return;
                    }
                    
                    // 顯示指示器
                    this.indicators.removeClass('hidden');
                    
                    // 生成點點
                    var self = this;
                    for (var i = 0; i < this.totalGroups; i++) {
                        var indicator = $('<button>')
                            .addClass('menu-carousel-indicator')
                            .attr('data-index', i)
                            .attr('aria-label', '切換到第 ' + (i + 1) + ' 組')
                            .on('click', function(e) {
                                var targetIndex = parseInt($(this).attr('data-index'));
                                self.currentIndex = targetIndex;
                                self.updatePosition();
                            });
                        
                        this.indicators.append(indicator);
                    }
                    
                    // 更新指示器狀態
                    this.updateIndicators();
                },
                
                // 更新指示器狀態
                updateIndicators: function() {
                    var self = this;
                    this.indicators.find('.menu-carousel-indicator').each(function(index) {
                        if (index === self.currentIndex) {
                            $(this).addClass('active');
                        } else {
                            $(this).removeClass('active');
                        }
                    });
                },
                
                // 更新輪播位置
                updatePosition: function() {
                    var itemWidth = 100 / this.itemsPerPage;
                    var translateX = -(this.currentIndex * itemWidth);
                    this.track.css('transform', 'translateX(' + translateX + '%)');
                    
                    // 更新指示器狀態
                    this.updateIndicators();
                },
                
                // 綁定所有事件監聽器
                bindEvents: function() {
                    var self = this;
                    
                    // 觸控事件：開始拖曳
                    this.container.on('touchstart', function(e) {
                        var touch = e.originalEvent.touches[0];
                        self.handleStart(touch.clientX, touch.clientY);
                    });
                    
                    // 觸控事件：拖曳中
                    this.container.on('touchmove', function(e) {
                        var touch = e.originalEvent.touches[0];
                        var deltaX = Math.abs(touch.clientX - self.startX);
                        var deltaY = Math.abs(touch.clientY - self.startY);
                        
                        // 如果橫向移動距離大於縱向移動，才視為在操作輪播，並阻止頁面捲動
                        if (deltaX > deltaY) {
                            if (e.cancelable) e.preventDefault();
                            self.handleMove(touch.clientX);
                        }
                    });
                    
                    // 觸控事件：結束拖曳
                    this.container.on('touchend', function(e) {
                        self.handleEnd();
                    });
                    
                    // 滑鼠事件：開始拖曳
                    this.container.on('mousedown', function(e) {
                        e.preventDefault();
                        self.handleStart(e.clientX);
                    });
                    
                    // 滑鼠事件：拖曳中
                    $(document).on('mousemove', function(e) {
                        if (self.isDragging) {
                            self.handleMove(e.clientX);
                        }
                    });
                    
                    // 滑鼠事件：結束拖曳
                    $(document).on('mouseup', function(e) {
                        if (self.isDragging) {
                            self.handleEnd();
                        }
                    });
                    
                    // 視窗大小改變時，重新計算每組顯示數量
                    $(window).on('resize', function() {
                        self.updateItemsPerGroup();
                        self.updatePosition();
                    });
                },
                
                // 處理拖曳開始
                handleStart: function(clientX, clientY) {
                    this.isDragging = true;
                    this.startX = clientX;
                    this.startY = clientY || 0;
                    this.currentX = clientX;
                    this.offsetX = 0;
                    this.track.css('transition', 'none');
                },
                
                // 處理拖曳移動
                handleMove: function(clientX) {
                    if (!this.isDragging) return;
                    
                    this.currentX = clientX;
                    this.offsetX = this.currentX - this.startX;
                    
                    var itemWidth = 100 / this.itemsPerPage;
                    var currentTranslate = -(this.currentIndex * itemWidth);
                    var dragTranslate = currentTranslate + (this.offsetX / this.container.width() * 100);
                    
                    var minTranslate = -(this.totalGroups - 1) * itemWidth;
                    var maxTranslate = 0;
                    
                    if (dragTranslate > maxTranslate) {
                        dragTranslate = maxTranslate;
                    } else if (dragTranslate < minTranslate) {
                        dragTranslate = minTranslate;
                    }
                    
                    this.track.css('transform', 'translateX(' + dragTranslate + '%)');
                },
                
                // 處理拖曳結束
                handleEnd: function() {
                    if (!this.isDragging) return;
                    
                    this.isDragging = false;
                    this.track.css('transition', 'transform 0.3s ease-out');
                    
                    if (Math.abs(this.offsetX) > this.threshold) {
                        if (this.offsetX > 0) {
                            this.prevGroup();
                        } else {
                            this.nextGroup();
                        }
                    } else {
                        this.updatePosition();
                    }
                },
                
                // 切換到下一組（循環：最後一組後回到第一組）
                nextGroup: function() {
                    this.currentIndex = (this.currentIndex + 1) % this.totalGroups;
                    this.updatePosition();
                },
                
                // 切換到上一組（循環：第一組後回到最後一組）
                prevGroup: function() {
                    this.currentIndex = (this.currentIndex - 1 + this.totalGroups) % this.totalGroups;
                    this.updatePosition();
                }
            };
            
            // 初始化菜單輪播
            menuCarousel.init();

            // ============================================
            // 菜單圖片點擊放大功能
            // ============================================
            
            var menuImageModal = {
                modal: $('#menuImageModal'),
                imageContainer: $('#menuModalImageContainer'),
                closeBtn: $('#menuModalClose'),
                isDragging: false,
                dragStartX: 0,
                dragStartY: 0,
                dragThreshold: 5,
                
                init: function() {
                    var self = this;
                    
                    $(document).on('click', '#menuCarouselContainer .menu-image', function(e) {
                        if (self.isDragging) {
                            return;
                        }
                        
                        var allMenuImages = [];
                        $('#menuCarouselContainer .menu-image').each(function() {
                            allMenuImages.push($(this).attr('src'));
                        });
                        
                        self.show(allMenuImages);
                    });
                    
                    this.closeBtn.on('click', function(e) {
                        e.stopPropagation();
                        self.hide();
                    });
                    
                    this.modal.on('click', function(e) {
                        if ($(e.target).hasClass('menu-image-modal')) {
                            self.hide();
                        }
                    });
                    
                    $(document).on('keydown', function(e) {
                        if (e.key === 'Escape' && self.modal.hasClass('show')) {
                            self.hide();
                        }
                    });
                    
                    $(document).on('mousedown touchstart', '#menuCarouselContainer .menu-image', function(e) {
                        var clientX = e.type === 'mousedown' ? e.clientX : e.originalEvent.touches[0].clientX;
                        var clientY = e.type === 'mousedown' ? e.clientY : e.originalEvent.touches[0].clientY;
                        
                        self.isDragging = false;
                        self.dragStartX = clientX;
                        self.dragStartY = clientY;
                    });
                    
                    $(document).on('mousemove touchmove', '#menuCarouselContainer .menu-image', function(e) {
                        var clientX = e.type === 'mousemove' ? e.clientX : (e.originalEvent.touches ? e.originalEvent.touches[0].clientX : 0);
                        var clientY = e.type === 'mousemove' ? e.clientY : (e.originalEvent.touches ? e.originalEvent.touches[0].clientY : 0);
                        
                        var deltaX = Math.abs(clientX - self.dragStartX);
                        var deltaY = Math.abs(clientY - self.dragStartY);
                        
                        if (deltaX > self.dragThreshold || deltaY > self.dragThreshold) {
                            self.isDragging = true;
                        }
                    });
                    
                    $(document).on('mouseup touchend', '#menuCarouselContainer .menu-image', function(e) {
                        setTimeout(function() {
                            self.isDragging = false;
                        }, 100);
                    });
                },
                
                show: function(imageSources) {
                    this.imageContainer.empty();
                    
                    var imageHtml = '';
                    for (var i = 0; i < imageSources.length; i++) {
                        imageHtml += '<img src="' + imageSources[i] + '" alt="菜單放大圖 ' + (i + 1) + '" class="menu-modal-image" />';
                    }
                    
                    this.imageContainer.html(imageHtml);
                    this.modal.addClass('show');
                    $('body').css('overflow', 'hidden');
                    this.modal.scrollTop(0);
                },
                
                hide: function() {
                    this.modal.removeClass('show');
                    this.imageContainer.empty();
                    $('body').css('overflow', 'auto');
                }
            };
            
            // 初始化菜單圖片放大功能
            menuImageModal.init();

            // 日期選擇器事件
            $('.reservation-date-input').on('change', function() {
                loadTimeSlots();
            });

            // 餐期標籤切換
            $('.meal-period-tab').on('click', function() {
                $('.meal-period-tab').removeClass('active');
                $(this).addClass('active');
                var period = $(this).data('period');
                $('#selectedMealPeriod').val(period);
                loadTimeSlots();
            });

            // 時段按鈕選擇
            $(document).on('click', '.time-slot-btn', function() {
                var slot = $(this).data('slot');
                if ($(this).hasClass('active')) {
                    // 取消選擇
                    $(this).removeClass('active');
                    $('#selectedTimeSlot').val('');
                } else {
                    // 選擇時段
                    $('.time-slot-btn').removeClass('active');
                    $(this).addClass('active');
                    $('#selectedTimeSlot').val(slot);
                }
            });

            // 載入時段
            function loadTimeSlots() {
                var date = $('#reservationDate').val();
                var period = $('#selectedMealPeriod').val();
                
                if (!date) {
                    date = '@DateTime.Today.ToString("yyyy-MM-dd")';
                    $('#reservationDate').val(date);
                }

                $.ajax({
                    url: '@Url.Action("GetTimeSlots", "Reservation")',
                    type: 'GET',
                    data: {
                        mealPeriod: period,
                        date: date
                    },
                    success: function(slots) {
                        var grid = $('#timeSlotsGrid');
                        grid.empty();
                        var selectedSlot = $('#selectedTimeSlot').val();
                        
                        if (slots && slots.length > 0) {
                            slots.forEach(function(slot) {
                                var isActive = slot === selectedSlot ? 'active' : '';
                                var btn = $('<button>')
                                    .attr('type', 'button')
                                    .addClass('time-slot-btn ' + isActive)
                                    .attr('data-slot', slot)
                                    .text(slot);
                                grid.append(btn);
                            });
                        } else {
                            grid.html('<p class="text-muted">暫無可用時段</p>');
                        }
                    },
                    error: function() {
                        $('#timeSlotsGrid').html('<p class="text-danger">載入時段失敗，請重新整理頁面</p>');
                    }
                });
            }

            if ($('#timeSlotsGrid').children().length === 0) {
                loadTimeSlots();
            }

        });
    </script>
}

