@model Reservation.Models.ViewModels.ReservationViewModel
@{
    ViewData["Title"] = "訂位";
}

<!-- 頂部 Header -->
<header class="reservation-header">
    <div class="container-fluid">
        <div class="row align-items-center">
            <div class="col-auto">
                <a href="@Url.Action("Index", "Restaurant")" class="back-button">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="white" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/>
                    </svg>
                </a>
            </div>
            <div class="col text-center">
                <h1 class="reservation-header-title">@Model.Branch.Name</h1>
            </div>
            <div class="col-auto" style="width: 24px;"></div>
        </div>
    </div>
</header>

<!-- 餐廳資訊卡片 -->
<div class="container-fluid px-3 py-3">
    <div class="restaurant-info-card">
        <div class="row g-0">
            <div class="col-4">
                <div class="restaurant-image-wrapper-reservation">
                    <img src="@Url.Content(Model.Restaurant.ImageUrl)" alt="@Model.Restaurant.Name" class="restaurant-image-reservation" />
                </div>
            </div>
            <div class="col-8">
                <div class="restaurant-details-reservation">
                    <h2 class="restaurant-name-reservation">@Model.Restaurant.Name</h2>
                    <div class="restaurant-detail-item">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="#258cfb" viewBox="0 0 16 16">
                            <path d="M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10zm0-7a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/>
                        </svg>
                        <span>@Model.Restaurant.Location</span>
                    </div>
                    <div class="restaurant-detail-item">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="#258cfb" viewBox="0 0 16 16">
                            <path d="M3.654 1.328a.678.678 0 0 0-1.015-.063L1.605 2.3c-.483.484-.661 1.169-.45 1.77a17.568 17.568 0 0 0 4.168 6.608 17.569 17.569 0 0 0 6.608 4.168c.601.211 1.286.033 1.77-.45l1.034-1.034a.678.678 0 0 0-.063-1.015l-2.307-1.794a.678.678 0 0 0-.58-.122L9.78 10.22a.678.678 0 0 1-.58-.122L6.5 7.5a.678.678 0 0 1-.122-.58l.122-1.034a.678.678 0 0 0-.122-.58L3.654 1.328z"/>
                        </svg>
                        <span>@Model.Restaurant.Phone</span>
                    </div>
                    <div class="restaurant-detail-item">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="#258cfb" viewBox="0 0 16 16">
                            <path d="M8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71V3.5z"/>
                            <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm7-8A7 7 0 1 1 1 8a7 7 0 0 1 14 0z"/>
                        </svg>
                        <span>@Model.Restaurant.OpeningHours</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 訂位資料區塊 -->
    <div class="reservation-form-section">
        <h3 class="section-title">訂位資料</h3>
        
        <form method="post" action="@Url.Action("Index", "Reservation")" id="reservationForm">
            <input type="hidden" name="Restaurant.Id" value="@Model.Restaurant.Id" />
            <input type="hidden" name="Branch.Id" value="@Model.Branch.Id" />
            
            <!-- 訂位日期 -->
            <div class="form-group mb-3">
                <label class="form-label">訂位日期</label>
                <input type="date" 
                       class="form-control reservation-date-input" 
                       name="SelectedDate" 
                       id="reservationDate"
                       value="@(Model.SelectedDate?.ToString("yyyy-MM-dd") ?? DateTime.Today.ToString("yyyy-MM-dd"))"
                       min="@DateTime.Today.ToString("yyyy-MM-dd")"
                       max="@DateTime.Today.AddDays(90).ToString("yyyy-MM-dd")"
                       required />
            </div>

            <!-- 人數選擇 -->
            <div class="row mb-3">
                <div class="col-6">
                    <label class="form-label">大人</label>
                    <select class="form-select" name="AdultCount" id="adultCount" required>
                        @for (int i = 1; i <= 8; i++)
                        {
                            <option value="@i" selected="@(Model.AdultCount == i)">@i 位</option>
                        }
                    </select>
                </div>
                <div class="col-6">
                    <label class="form-label">小孩</label>
                    <select class="form-select" name="ChildCount" id="childCount">
                        @for (int i = 0; i <= 8; i++)
                        {
                            <option value="@i" selected="@(Model.ChildCount == i)">@i 位</option>
                        }
                    </select>
                </div>
            </div>
            <p class="reservation-info-text">線上訂位最多可至8位,如需團體訂位請撥打餐廳電話。</p>

            <!-- 時段選擇 -->
            <div class="time-slot-section">
                <div class="meal-period-tabs">
                    <button type="button" class="meal-period-tab active" data-period="中午">中午</button>
                    <button type="button" class="meal-period-tab" data-period="晚上">晚上</button>
                </div>
                <input type="hidden" name="SelectedMealPeriod" id="selectedMealPeriod" value="@Model.SelectedMealPeriod" />
                
                <div class="time-slots-grid" id="timeSlotsGrid">
                    @foreach (var slot in Model.AvailableTimeSlots)
                    {
                        <button type="button" 
                                class="time-slot-btn @(Model.SelectedTimeSlot == slot ? "active" : "")" 
                                data-slot="@slot">
                            @slot
                        </button>
                    }
                </div>
                <input type="hidden" name="SelectedTimeSlot" id="selectedTimeSlot" value="@Model.SelectedTimeSlot" />
            </div>

            <!-- 下一步按鈕 -->
            <div class="text-center mt-4">
                <button type="submit" class="btn btn-next-step">下一步</button>
            </div>
        </form>
    </div>

    <!-- 菜單展示區域 -->
    <div class="menu-section">
        <h3 class="section-title">美味菜單</h3>
        <div class="menu-carousel-container">
            <div class="menu-carousel" id="menuCarousel">
                @foreach (var menu in Model.Menus)
                {
                    <div class="menu-card" data-menu-image="@Url.Content(menu.ImageUrl)" data-bs-toggle="modal" data-bs-target="#menuImageModal">
                        <img src="@Url.Content(menu.ImageUrl)" alt="@menu.Title" class="menu-card-image" />
                    </div>
                }
            </div>
            <!-- 左右箭頭導航 -->
            <button class="menu-carousel-nav menu-carousel-prev" id="menuCarouselPrev" type="button">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="white" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"/>
                </svg>
            </button>
            <button class="menu-carousel-nav menu-carousel-next" id="menuCarouselNext" type="button">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="white" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/>
                </svg>
            </button>
        </div>
    </div>

    <!-- 圖片放大 Modal -->
    <div class="modal fade" id="menuImageModal" tabindex="-1" aria-labelledby="menuImageModalLabel" aria-hidden="true" data-bs-backdrop="true" data-bs-keyboard="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content menu-image-modal-content">
                <div class="modal-header menu-image-modal-header">
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body menu-image-modal-body">
                    <div class="menu-image-wrapper">
                        <img id="menuModalImage" src="" alt="菜單" class="menu-modal-image" draggable="false" />
                    </div>
                    <!-- 左右箭頭導航 -->
                    <button class="menu-modal-nav menu-modal-prev" id="menuModalPrev" type="button">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="white" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"/>
                        </svg>
                    </button>
                    <button class="menu-modal-nav menu-modal-next" id="menuModalNext" type="button">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="white" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 訂位成功彈窗 -->
    <div class="modal fade" id="reservationSuccessModal" tabindex="-1" aria-labelledby="reservationSuccessModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content reservation-success-modal">
                <button type="button" class="btn-close btn-close-white reservation-close-btn" data-bs-dismiss="modal" aria-label="Close"></button>
                
                <div class="reservation-success-content">
                    <div class="success-icon-wrapper">
                        <div class="success-checkmark">
                            <svg viewBox="0 0 52 52" class="checkmark-svg">
                                <circle class="checkmark-circle" cx="26" cy="26" r="25" fill="none" stroke="white" stroke-width="2"/>
                                <path class="checkmark-check" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
                            </svg>
                        </div>
                    </div>
                    
                    <h2 class="reservation-success-title">訂位完成</h2>
                    
                    <p class="reservation-success-message">
                        可於遠百APP,【個人訊息功能】查詢訂候位記錄
                    </p>
                    
                    <button type="button" class="btn reservation-query-btn" onclick="window.location.href='@Url.Action("Index", "Restaurant")'">
                        訂位紀錄查詢
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // 日期選擇器事件
            $('.reservation-date-input').on('change', function() {
                loadTimeSlots();
            });

            // 餐期標籤切換
            $('.meal-period-tab').on('click', function() {
                $('.meal-period-tab').removeClass('active');
                $(this).addClass('active');
                var period = $(this).data('period');
                $('#selectedMealPeriod').val(period);
                loadTimeSlots();
            });

            // 時段按鈕選擇
            $(document).on('click', '.time-slot-btn', function() {
                var slot = $(this).data('slot');
                if ($(this).hasClass('active')) {
                    // 取消選擇
                    $(this).removeClass('active');
                    $('#selectedTimeSlot').val('');
                } else {
                    // 選擇時段
                    $('.time-slot-btn').removeClass('active');
                    $(this).addClass('active');
                    $('#selectedTimeSlot').val(slot);
                }
            });

            // 載入時段
            function loadTimeSlots() {
                var date = $('#reservationDate').val();
                var period = $('#selectedMealPeriod').val();
                
                if (!date) {
                    date = '@DateTime.Today.ToString("yyyy-MM-dd")';
                    $('#reservationDate').val(date);
                }

                $.ajax({
                    url: '@Url.Action("GetTimeSlots", "Reservation")',
                    type: 'GET',
                    data: {
                        mealPeriod: period,
                        date: date
                    },
                    success: function(slots) {
                        var grid = $('#timeSlotsGrid');
                        grid.empty();
                        var selectedSlot = $('#selectedTimeSlot').val();
                        
                        if (slots && slots.length > 0) {
                            slots.forEach(function(slot) {
                                var isActive = slot === selectedSlot ? 'active' : '';
                                var btn = $('<button>')
                                    .attr('type', 'button')
                                    .addClass('time-slot-btn ' + isActive)
                                    .attr('data-slot', slot)
                                    .text(slot);
                                grid.append(btn);
                            });
                        } else {
                            grid.html('<p class="text-muted">暫無可用時段</p>');
                        }
                    },
                    error: function() {
                        $('#timeSlotsGrid').html('<p class="text-danger">載入時段失敗，請重新整理頁面</p>');
                    }
                });
            }

            if ($('#timeSlotsGrid').children().length === 0) {
                loadTimeSlots();
            }

            // 菜單輪播功能 - 位置交換邏輯（示例代碼模式）
            var menuCards = $('.menu-card');
            var totalMenus = menuCards.length;
            
            // 定義三個位置類的陣列，對應 [左, 中, 右]
            var slots = ['slot-left', 'slot-center', 'slot-right'];
            
            // 收集菜單圖片，供放大後切換
            var menuImages = [];
            var currentMenuIndex = 0;
            $('.menu-card').each(function (index) {
                menuImages.push($(this).data('menu-image'));
            });

            // 初始化輪播：分配初始位置
            function initCarousel() {
                if (totalMenus === 0) return;
                
                // 重置位置陣列
                slots = ['slot-left', 'slot-center', 'slot-right'];
                
                // 只處理前3張卡片（如果超過3張）
                var cardsToShow = Math.min(3, totalMenus);
                
                // 清除所有位置類並重新分配
                menuCards.each(function(index) {
                    if (index < cardsToShow) {
                        $(this)
                            .removeClass('slot-left slot-center slot-right')
                            .addClass(slots[index])
                            .show();
                    } else {
                        $(this).hide();
                    }
                });
            }
            
            // 向前旋轉（下一張）：圖1→圖2位置, 圖2→圖3位置, 圖3→圖1位置
            function rotateForward() {
                if (totalMenus === 0) return;
                
                // 陣列左旋轉：取出第一個，放到最後
                // ['slot-left', 'slot-center', 'slot-right']
                // → ['slot-center', 'slot-right', 'slot-left']
                var firstSlot = slots.shift();
                slots.push(firstSlot);
                
                // 重新分配位置類
                var cardsToShow = Math.min(3, totalMenus);
                menuCards.each(function(index) {
                    if (index < cardsToShow) {
                        $(this)
                            .removeClass('slot-left slot-center slot-right')
                            .addClass(slots[index]);
                    }
                });
            }
            
            // 向後旋轉（上一張）：圖1→圖3位置, 圖2→圖1位置, 圖3→圖2位置
            function rotateBackward() {
                if (totalMenus === 0) return;
                
                // 陣列右旋轉：取出最後一個，放到最前面
                var lastSlot = slots.pop();
                slots.unshift(lastSlot);
                
                // 重新分配位置類
                var cardsToShow = Math.min(3, totalMenus);
                menuCards.each(function(index) {
                    if (index < cardsToShow) {
                        $(this)
                            .removeClass('slot-left slot-center slot-right')
                            .addClass(slots[index]);
                    }
                });
            }
            
            // 左右箭頭導航
            $('#menuCarouselPrev').on('click', function() {
                rotateBackward();
            });
            
            $('#menuCarouselNext').on('click', function() {
                rotateForward();
            });
            
            // 觸摸滑動支持（移動端）
            var touchStartX = 0;
            var touchEndX = 0;
            
            $('#menuCarousel').on('touchstart', function(e) {
                touchStartX = e.originalEvent.touches[0].clientX;
            });
            
            $('#menuCarousel').on('touchend', function(e) {
                touchEndX = e.originalEvent.changedTouches[0].clientX;
                var swipeThreshold = 50;
                var diff = touchStartX - touchEndX;
                
                if (Math.abs(diff) > swipeThreshold) {
                    if (diff > 0) {
                        // 向左滑動，下一張
                        rotateForward();
                    } else {
                        // 向右滑動，上一張
                        rotateBackward();
                    }
                }
            });
            
            // 初始化
            initCarousel();
            
            // 點擊菜單卡片時載入圖片到 Modal
            $('.menu-card').on('click', function() {
               currentMenuIndex = $(this).index();
               var imageUrl = $(this).data('menu-image');
               $('#menuModalImage').attr('src', imageUrl);              
            });


            // 顯示上一張菜單圖片（循環）
            function showPreviousMenuImage() {
                if (menuImages.length === 0) return;
                currentMenuIndex = (currentMenuIndex - 1 + menuImages.length) % menuImages.length;
                $('#menuModalImage').attr('src', menuImages[currentMenuIndex]);
            }

            // 顯示下一張菜單圖片（循環）
            function showNextMenuImage() {
                if (menuImages.length === 0) return;
                currentMenuIndex = (currentMenuIndex + 1) % menuImages.length;
                $('#menuModalImage').attr('src', menuImages[currentMenuIndex]);
            }
             
            // Modal 內觸摸滑動切換（支援觸控和滑鼠）
            var modalTouchStartX = 0;
            var modalMouseStartX = 0;
            var isDragging = false;

            // 觸控事件（手機）
            $('#menuModalImage,.menu-image-wrapper').on('touchstart', function(e) {
                modalTouchStartX = e.originalEvent.touches[0].clientX;
            });

            $('#menuModalImage,.menu-image-wrapper').on('touchend', function(e) {
                var modalTouchEndX = e.originalEvent.changedTouches[0].clientX;
                var swipeThreshold = 50;
                var diff = modalTouchStartX - modalTouchEndX;

                if (Math.abs(diff) > swipeThreshold) {
                    if (diff > 0) {
                        showNextMenuImage();
                    } else {
                        showPreviousMenuImage();
                    }
                }
            });

            // 滑鼠事件（網頁）
            $('#menuModalImage,.menu-image-wrapper').on('mousedown', function(e) {
                isDragging = true;
                modalMouseStartX = e.clientX;
                e.preventDefault(); // 防止圖片被拖曳
            });

            $(document).on('mousemove', function(e) {
                if (!isDragging) return;
                e.preventDefault();
            });

            $(document).on('mouseup', function(e) {
                if (!isDragging) return;

                var modalMouseEndX = e.clientX;
                var swipeThreshold = 50;
                var diff = modalMouseStartX - modalMouseEndX;

                if (Math.abs(diff) > swipeThreshold) {
                    if (diff > 0) {
                        // 向左拖曳，下一張
                        showNextMenuImage();
                    } else {
                        // 向右拖曳，上一張
                        showPreviousMenuImage();
                    }
                }

                isDragging = false;
            });

            // Modal 關閉時重置拖曳狀態
            $('#menuImageModal').on('hidden.bs.modal', function() {
                isDragging = false;
                $('#menuModalImage').attr('src', '');
            });

            // Modal 內箭頭點擊切換
            $('#menuModalPrev').on('click',function(e){
                e.preventDefault();
                showPreviousMenuImage();
            });

            $('#menuModalNext').on('click',function(e){
                e.preventDefault();
                showNextMenuImage();
            });


            // 監聽鍵盤按鍵事件（Modal 開啟時左右切換）
            $(document).on('keydown',function(e){
                if($('#menuImageModal').hasClass('show')){
                    if(e.key === 'ArrowLeft'){
                        e.preventDefault();
                        showPreviousMenuImage();
                    }else if(e.key === 'ArrowRight'){
                        e.preventDefault();
                        showNextMenuImage();
                    }
                }
            });
            
            // 點擊 modal 背景時關閉
            $('#menuImageModal').on('click', function(e) {
                // 如果點擊的不是 modal-content 或其子元素，則關閉
                if (!$(e.target).closest('.menu-image-modal-content').length) {
                    var modalElement = document.getElementById('menuImageModal');
                    var modal = bootstrap.Modal.getInstance(modalElement);
                    if (modal) {
                        modal.hide();
                    }
                }
            });
            
            // Modal 關閉時清空圖片（可選）
            $('#menuImageModal').on('hidden.bs.modal', function() {
                $('#menuModalImage').attr('src', '');
            });

        });
    </script>
}

